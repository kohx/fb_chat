<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Sample FirebaseUI App</title>
    <!-- <script src="https://www.gstatic.com/firebasejs/5.0.3/firebase.js"></script> -->
    <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>

    <style>
        #info {
            padding: .6rem;
            margin: 10px 0;
            border: 1px solid silver;
        }

        #info h2 {
            font-size: 1rem;
            font-weight: bold;
            padding: 0;
            margin: 0;
        }

        .user_box {
            border: 1px solid silver;
            font-size: 0.6rem;
            padding: 0.6rem;
            margin: 0;
        }

        .user_title {
            font-weight: bold;
        }

        #sign_box,
        #resign_box,
        #add_provider,
        #update_box {
            border: 1px solid silver;
            margin: 10px 0;
            padding: .6rem;
        }

        .flex {
            display: flex;
        }

        button,
        input {
            flex: 1;
            margin: 1px;
        }
    </style>
</head>

<body>

    <div>
        <img class="user_photo" height="30">
        <span class="user_display_name"></span>
        [
        <span class="user_email"></span> ]
        <button type="button" id="signout" disabled>signout</button>
        <div id="info"></div>
    </div>

    <div>sign</div>
    <div id="sign_box">
        <div class="flex">
            <input id="sign_email" type="email" placeholder="sign email" disabled>
            <input id="sign_password" type="password" placeholder="sign password" disabled>
        </div>
        <div class="flex">
            <button type="button" id="signin_password" disabled>signin password</button>
            <button type="button" id="signin_mail_link" disabled>signin mail link</button>
            <button type="button" id="signup" disabled>signup</button>
        </div>
        <div id="signin_google" class="flex">
            <button type="button" class="signin_provider" data-provider="google" data-action="popup" disabled>google popup</button>
            <button type="button" class="signin_provider" data-provider="google" data-action="redirect" disabled>google redirect</button>
        </div>
        <div id="signin_facebook" class="flex">
            <button type="button" class="signin_provider" data-provider="facebook" data-action="popup" disabled>facebook popup</button>
            <button type="button" class="signin_provider" data-provider="facebook" data-action="redirect" disabled>facebook redirect</button>
        </div>
        <div id="signin_github" class="flex">
            <button type="button" class="signin_provider" data-provider="github" data-action="popup" disabled>github popup</button>
            <button type="button" class="signin_provider" data-provider="github" data-action="redirect" disabled>github redirect</button>
        </div>
        <div id="signin_twitter" class="flex">
            <button type="button" class="signin_provider" data-provider="twitter" data-action="popup" disabled>twitter popup</button>
            <button type="button" class="signin_provider" data-provider="twitter" data-action="redirect" disabled>twitter redirect</button>
        </div>
    </div>

    <div>resignin</div>
    <div id="resign_box">
        <div class="flex">
            <input id="resignin_password" type="password" placeholder="resignin password" disabled>
            <button type="button" id="resignin" disabled>resignin</button>
        </div>
        <div id="resignin_google" class="flex">
            <button type="button" class="resignin_provider" data-provider="google" data-action="popup" disabled>resignin google popup</button>
            <button type="button" class="resignin_provider" data-provider="google" data-action="redirect" disabled>resignin google redirect</button>
        </div>
        <div id="resignin_facebook" class="flex">
            <button type="button" class="resignin_provider" data-provider="facebook" data-action="popup" disabled>resignin facebook popup</button>
            <button type="button" class="resignin_provider" data-provider="facebook" data-action="redirect" disabled>resignin facebook redirect</button>
        </div>
        <div id="resignin_github" class="flex">
            <button type="button" class="resignin_provider" data-provider="github" data-action="popup" disabled>resignin github popup</button>
            <button type="button" class="resignin_provider" data-provider="github" data-action="redirect" disabled>resignin github redirect</button>
        </div>
        <div id="resignin_twitter" class="flex">
            <button type="button" class="resignin_provider" data-provider="twitter" data-action="popup" disabled>resignin twitter popup</button>
            <button type="button" class="resignin_provider" data-provider="twitter" data-action="redirect" disabled>resignin twitter redirect</button>
        </div>
    </div>

    <div>add sign in provider</div>
    <div id="add_provider">
        <div id="add_provider_mail_password">
            <div class="flex">
                <input id="add_provider_mail" type="email" placeholder="email" disabled>
                <input id="add_provider_password" type="password" placeholder="password" disabled>
            </div>
            <div class="flex">
                <button type="button" class="add_provider" disabled>mail link add</button>
                <button type="button" class="remove_provider" data-provider="password" data-action="" disabled>mail link remove</button>
            </div>
        </div>
        <div id="add_google" class="flex">
            <button type="button" class="add_provider" data-provider="google.com" data-action="popup" disabled>google popup</button>
            <button type="button" class="add_provider" data-provider="google.com" data-action="redirect" disabled>google redirect</button>
            <button type="button" class="remove_provider" data-provider="google.com" data-action="redirect" disabled>google remove</button>
        </div>
        <div id="add_facebook" class="flex">
            <button type="button" class="add_provider" data-provider="facebook.com" data-action="popup" disabled>facebook popup</button>
            <button type="button" class="add_provider" data-provider="facebook.com" data-action="redirect" disabled>facebook redirect</button>
            <button type="button" class="remove_provider" data-provider="facebook.com" data-action="redirect" disabled>facebook remove</button>
        </div>
        <div id="add_github" class="flex">
            <button type="button" class="add_provider" data-provider="github.com" data-action="popup" disabled>github popup</button>
            <button type="button" class="add_provider" data-provider="github.com" data-action="redirect" disabled>github redirect</button>
            <button type="button" class="remove_provider" data-provider="github.com" data-action="redirect" disabled>github remove</button>
        </div>
        <div id="add_twitter" class="flex">
            <button type="button" class="add_provider" data-provider="twitter.com" data-action="popup" disabled>twitter popup</button>
            <button type="button" class="add_provider" data-provider="twitter.com" data-action="redirect" disabled>twitter redirect</button>
            <button type="button" class="remove_provider" data-provider="twitter.com" data-action="redirect" disabled>twitter remove</button>
            <br>
        </div>
    </div>

    <div>update user proparty</div>
    <div id="update_box">
        <div class="flex">
            <input type="text" id="update_display_name" placeholder="display name">
            <input type="text" id="update_photo_url" placeholder="photo url">
            <button type="button" id="updata_dysplay_name_and_photo_url">update display name and photo url</button>
        </div>

        <div class="flex">
            <input type="text" id="update_email_address" placeholder="update email address">
            <button type="button" id="update_email">update email</button>
        </div>

        <div class="flex">
            <button type="button" id="send_email_verification">send email verification</button>
        </div>

        <div class="flex">
            <button type="button" id="update_password">update password</button>
        </div>

        <div class="flex">
            <input type="text" id="to_email_address" placeholder="to email address">
            <button type="button" id="send_password_reset_email">send password reset email</button>
        </div>
    </div>

    <div class="user_box">
        <div class="user_title">uid</div>
        <div class="user_value user_uid"></div>
        <div class="user_title">user_displayName</div>
        <div class="user_value user_display_name"></div>
        <div class="user_title">user_email</div>
        <div class="user_value user_email"></div>
        <div class="user_title">user_email_verified</div>
        <div class="user_value user_email_verified"></div>
        <div class="user_title">user_creation_time</div>
        <div class="user_value user_creation_time"></div>
        <div class="user_title">user_last_signin_time</div>
        <div class="user_value user_last_signin_time"></div>
        <div class="user_title">user_phone_number</div>
        <div class="user_value user_phone_number"></div>
        <div class="user_title">user_photo_url</div>
        <div class="user_value user_photo_url"></div>
        <div class="user_title">user_provider_data</div>
        <div class="user_value user_provider_data"></div>
    </div>

    <script type="text/javascript">
        // Initialize Firebase
        const config = {
            apiKey: "AIzaSyC_DO9wHhHtZ0Ei7BtmM7mLcMG-4h0rx-I",
            authDomain: "freindlychat-16c81.firebaseapp.com",
            databaseURL: "https://freindlychat-16c81.firebaseio.com",
            projectId: "freindlychat-16c81",
            storageBucket: "freindlychat-16c81.appspot.com",
            messagingSenderId: "743147525524"
        };
        firebase.initializeApp(config)

        // elements
        const info = get('#info')

        // Language setting
        firebase.auth().languageCode = 'ja'
        // firebase.auth().useDeviceLanguage()


        // ディスプレイネームとフォトURLの更新
        get('#updata_dysplay_name_and_photo_url').addEventListener('click', event => {
            const user = firebase.auth().currentUser;
            if (!user) {
                return
            }

            let updateData = {}
            if (get('#update_display_name').value) {
                updateData.displayName = get('#update_display_name').value
            }
            if (get('#update_photo_url').value) {
                updateData.photoURL = get('#update_photo_url').value
            }

            if (updateData) {
                user.updateProfile(updateData)
                    .then(result => {
                        all('.user_display_name').forEach(element => {
                            element.textContent = updateData.displayName
                        })
                        all('.user_photo').forEach(element => {
                            element.src = updateData.photoURL
                        })
                        notice(info, 'info', 'change displayname, user photo!')
                    })
                    .catch(error => {
                        notice(info, error.code, error.message)
                    });
            }
        })

        // Eメールのアップデート
        get('#update_email').addEventListener('click', event => {
            const user = firebase.auth().currentUser;
            if (!user) {
                return
            }

            const email = get('#update_email_address').value
            if (email) {
                user.updateEmail(email)
                    .then(result => {
                        all('.user_email').forEach(element => {
                            element.textContent = email
                        })
                        notice(info, 'info', 'change your email address!')
                    })
                    .catch(error => {
                        notice(info, error.code, error.message)
                    });
            }
        })

        // ユーザーに確認メールを送信する
        get('#send_email_verification').addEventListener('click', event => {
            const user = firebase.auth().currentUser;
            if (!user) {
                return
            }
            if (!user.email) {
                notice(info, 'error', 'you don\'t have email!')
                return
            }
            // 送信
            user.sendEmailVerification({
                url: 'http://localhost:5000/login.html/?email=' + firebase.auth().currentUser.email,
                handleCodeInApp: true
            })
                .then(result => {
                    notice(info, 'info', 'sent verification email, check your email!')
                })
                .catch(error => {
                    notice(info, error.code, error.message)
                });
        })

        // ユーザーのパスワードを設定する
        get('#update_password').addEventListener('click', event => {
            const user = firebase.auth().currentUser
            if (!user) {
                return
            }
            if (!user.email) {
                notice(info, 'error', 'you don\'t have email!')
                return
            }
            // create new password
            newPassword = Math.random().toString(36).slice(-8);;
            user.updatePassword(newPassword)
                .then(result => {
                    changeUi(user)
                    notice(info, 'info', `change password to [${newPassword}]`)
                })
                .catch(error => {
                    notice(info, error.code, error.message)
                })

        })

        // パスワードの再設定メールを送信する
        get('#send_password_reset_email').addEventListener('click', event => {
            const user = firebase.auth().currentUser
            if (!user) {
                return
            }

            // set to email address
            let emailAddress = get('#to_email_address').value
            if (!emailAddress && user.email) {
                emailAddress = user.email
            }

            if (!emailAddress) {
                notice(info, 'error', 'input email address!')
                return
            }

            firebase.auth().sendPasswordResetEmail(emailAddress, {
                url: 'http://localhost:5000/login.html/?email=' + firebase.auth().currentUser.email,
                handleCodeInApp: true
            })
                .then(result => {
                    notice(info, 'info', 'sent reset password email, check your email!')
                })
                .catch(error => {
                    notice(info, error.code, error.message)
                });
        })


        /* 
         * sign up
         * サインアップ
         *-------------------------------------------------------------------
         */
        get('#signup').addEventListener('click', () => {
            const email = get('#sign_email').value
            const password = get('#sign_password').value
            // sign up
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then(user => {
                    console.log('メールとパスワードでサインアップ！')
                    console.log(user)
                })
                .catch(error => {
                    notice(info, error.code, error.message)
                })
        })

        /* 
         * sign in
         * メールとパスワードでサインイン
         *-------------------------------------------------------------------
         */
        get('#signin_password').addEventListener('click', () => {
            const email = get('#sign_email').value
            const password = get('#sign_password').value

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(user => {

                })
                .catch(error => {
                    notice(info, error.code, error.message)
                })
        })

        /* 
         * signin with mail-link
         * メールリンクでサインイン
         *-------------------------------------------------------------------
         */
        get('#signin_mail_link').addEventListener('click', event => {
            const email = get('#sign_email').value
            firebase.auth().sendSignInLinkToEmail(email, {
                // URL you want to redirect back to. The domain (www.example.com) for this
                // URL must be whitelisted in the Firebase Console.
                url: 'http://localhost:5000/login.html',
                // This must be true.
                handleCodeInApp: true
            })
                .then(() => {
                    // The link was successfully sent. Inform the user.
                    // Save the email locally so you don't need to ask the user for it again
                    // if they open the link on the same device.
                    window.localStorage.setItem('emailForSignIn', email);
                    notice(info, 'info', 'email for sign in seved.<br>check your email and click signin url.')
                })
                .catch(error => {
                    notice(info, error.code, error.message)
                })
        })

        /* 
         * receive then signin with mail-link
         * メールリンクでサインインした場合の受け
         *-------------------------------------------------------------------
         */
        if (firebase.auth().isSignInWithEmailLink(window.location.href)) {

            // Confirm the link is a sign-in with email link.
            let emailForSignIn = window.localStorage.getItem('emailForSignIn');

            // if emailForSignIn is not in localstorage, ask email to user
            if (!emailForSignIn) {

                emailForSignIn = window.prompt('Please provide your email for confirmation');
            }

            firebase.auth().signInWithEmailLink(emailForSignIn, window.location.href)
                .then(result => {
                    // Clear email from storage.
                    window.localStorage.removeItem('emailForSignIn');

                    // result
                    console.log('メールとパスワードでサインイン')
                    const isNewUser = result.additionalUserInfo.isNewUser
                    const providerId = result.additionalUserInfo.providerId
                    const operationType = result.operationType
                    const user = result.user
                    const credential = result.credential;
                    const token = result.credential.accessToken;
                    console.log(isNewUser)
                    console.log(providerId)
                    console.log(credential)
                    console.log(operationType)
                    console.log(token)
                    console.log(user)
                })
                .catch(error => {
                    notice(info, error.code, error.message)
                })
        }

        /* 
         * signin with social media provider
         * ソーシャルメディアプロバイダでサインイン
         *-------------------------------------------------------------------
         */
        all('.signin_provider').forEach(element => {
            element.addEventListener('click', event => {
                const target = event.target.dataset
                let provider = null
                switch (target.provider) {
                    case 'google':
                        provider = new firebase.auth.GoogleAuthProvider()
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'login_hint': 'user@example.com'
                        })
                        break;

                    case 'facebook':
                        provider = new firebase.auth.FacebookAuthProvider();
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'display': 'popup'
                        });
                        break;

                    case 'github':
                        provider = new firebase.auth.GithubAuthProvider();
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'allow_signup': 'false'
                        })
                        break;

                    case 'twitter':
                        provider = new firebase.auth.TwitterAuthProvider();
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'lang': 'ja'
                        });
                        break;

                    default:
                        break;
                }

                if (target.action == 'popup') {
                    firebase.auth().signInWithPopup(provider)
                        .then(result => {
                            console.log('ソーシャルメディアプロバイダでサインイン')
                            const isNewUser = result.additionalUserInfo.isNewUser
                            const providerId = result.additionalUserInfo.providerId
                            const operationType = result.operationType
                            const user = result.user
                            const credential = result.credential;
                            const token = result.credential.accessToken;
                            console.log(isNewUser)
                            console.log(providerId)
                            console.log(credential)
                            console.log(operationType)
                            console.log(token)
                            console.log(user)
                        })
                        .catch(error => {
                            notice(info, error.code, error.message)
                            console.log(error.email)
                            console.log(error.credential)
                        })
                }

                if (target.action == 'redirect') {
                    firebase.auth().signInWithRedirect(provider)
                }
            })
        })

        /* 
         * add social media provider
         * ソーシャルメディアプロバイダ追加
         *-------------------------------------------------------------------
         */
        all('.add_provider').forEach(addProvider => {
            addProvider.addEventListener('click', event => {
                const currentUser = firebase.auth().currentUser
                const target = event.target.dataset
                let provider = null
                switch (target.provider) {
                    case 'google.com':
                        provider = new firebase.auth.GoogleAuthProvider()
                        break;
                    case 'facebook.com':
                        provider = new firebase.auth.FacebookAuthProvider();
                        break;
                    case 'github.com':
                        provider = new firebase.auth.GithubAuthProvider();
                        break;
                    case 'twitter.com':
                        provider = new firebase.auth.TwitterAuthProvider();
                        break;
                    default:
                        break;
                }

                if (target.action == 'popup') {
                    currentUser.linkWithPopup(provider)
                        .then(result => {
                            console.log('ソーシャルメディアプロバイダ追加')
                            const isNewUser = result.additionalUserInfo.isNewUser
                            const providerId = result.additionalUserInfo.providerId
                            const operationType = result.operationType
                            const user = result.user
                            const credential = result.credential;
                            const token = result.credential.accessToken;
                            console.log(isNewUser)
                            console.log(providerId)
                            console.log(credential)
                            console.log(operationType)
                            console.log(token)
                            console.log(user)
                            changeUi(user)
                        })
                        .catch(error => {
                            if (error.credential) {

                                // 他アカウントの統合メソッドを呼び出し
                                otherSignin(error.credential)
                            } else {
                                notice(info, error.code, error.message)
                            }
                        })
                }

                if (target.action == 'redirect') {
                    currentUser.linkWithRedirect(provider)
                }
            })
        })

        /* 
         * resign in with password
         * パスワードで再サインイン
         * https://firebase.google.com/docs/reference/js/firebase.User#reauthenticateWithRedirect
         *-------------------------------------------------------------------
         */
         get('#resignin').addEventListener('click', event => {
            const user = firebase.auth().currentUser;
            if (!user) {
                return
            }
            const password = get('#resignin_password').value
            credential = firebase.auth.EmailAuthProvider.credential(user.email, password)
            user.reauthenticateWithCredential(credential)
                .then(result => {
                    notice(info, 'info', 'user resignin!')
                })
                .catch(error => {
                    notice(info, error.code, error.message)
                })
        })

        /* 
         * resign in with provider
         * プロバイダで再サインイン
         * https://firebase.google.com/docs/reference/js/firebase.User#reauthenticateWithRedirect
         *-------------------------------------------------------------------
         */
        all('.resignin_provider').forEach(element => {
            element.addEventListener('click', event => {
                const user = firebase.auth().currentUser;
                if (!user) {
                    return

                }
                const target = event.target.dataset
                let provider = null
                switch (target.provider) {
                    case 'google':
                        provider = new firebase.auth.GoogleAuthProvider()
                        break;

                    case 'facebook':
                        provider = new firebase.auth.FacebookAuthProvider();
                        break;

                    case 'github':
                        provider = new firebase.auth.GithubAuthProvider();
                        break;

                    case 'twitter':
                        provider = new firebase.auth.TwitterAuthProvider();
                        break;

                    default:
                        break;
                }

                if (target.action == 'popup') {
                    user.reauthenticateWithPopup(provider)
                        .then(result => {
                            notice(info, 'info', 'user resignin!')
                        })
                        .catch(error => {
                            notice(info, error.code, error.message)
                        })
                }

                if (target.action == 'redirect') {
                    user.reauthenticateWithRedirect(provider)
                }
            })
        })

        /* 
         * recieve then signin with social media provider
         * recieve then sdd social media provider
         * ソーシャルメディアプロバイダでリダイレクトサインインした場合の受け
         * ソーシャルメディアプロバイダリダイレクト追加した場合の受け
         * プロバイダでリダイレクト再サインインした場合の受け
         *-------------------------------------------------------------------
         */
        firebase.auth().getRedirectResult()
            .then(result => {
                if (result.credential) {
                    console.log('リダイレクト受け')
                    console.log(result)
                    const isNewUser = result.additionalUserInfo.isNewUser
                    const providerId = result.additionalUserInfo.providerId
                    const operationType = result.operationType
                    const user = result.user
                    const credential = result.credential;
                    const token = result.credential.accessToken;
                    console.log(isNewUser)
                    console.log(providerId)
                    console.log(credential)
                    console.log(operationType)
                    console.log(token)
                    console.log(user)
                }
            })
            .catch(error => {
                if (error.credential) {

                    // 他アカウントの統合メソッドを呼び出し
                    otherSignin(error.credential)
                } else {
                    notice(info, error.code, error.message)
                }
            })

        /* 
         * add mail-password provider
         * メイルパスワードプロバイダ追加
         *-------------------------------------------------------------------
         */
        get('#add_provider_mail_password .add_provider').addEventListener('click', event => {
            const currentUser = firebase.auth().currentUser
            if (!currentUser) {
                return
            }
            const email = get('#add_provider_mail').value
            const password = get('#add_provider_password').value
            // get credential
            const credential = firebase.auth.EmailAuthProvider.credential(email, password)
            currentUser.linkAndRetrieveDataWithCredential(credential)
                .then(result => {
                    console.log('メイルパスワードプロバイダ追加')
                    const isNewUser = result.additionalUserInfo.isNewUser
                    const providerId = result.additionalUserInfo.providerId
                    const operationType = result.operationType
                    const user = result.user
                    const credential = result.credential;
                    const token = result.credential.accessToken;
                    console.log(isNewUser)
                    console.log(providerId)
                    console.log(credential)
                    console.log(operationType)
                    console.log(token)
                    console.log(user)
                    changeUi(result.user)
                    changeUserInfo(result.user)
                })
                .catch(error => {
                    if (error.credential) {

                        // 他アカウントの統合メソッドを呼び出し
                        otherSignin(error.credential)
                    } else {
                        notice(info, error.code, error.message)
                    }
                })
        })

        /* 
         * remove provider link
         * プロバイダのリムーブ
         *-------------------------------------------------------------------
         */
        all('.remove_provider').forEach(removeProvdier => {
            removeProvdier.addEventListener('click', event => {
                const currentUser = firebase.auth().currentUser
                const providerId = event.target.dataset.provider
                // give provider id
                currentUser.unlink(providerId)
                    .then(user => {
                        changeUi(user)
                        changeUserInfo(user)
                    })
                    .catch(error => {
                        notice(info, error.code, error.message)
                        console.log(error.email)
                        console.log(error.credential)
                    })
            })
        })

        /* 
         * sign out
         * サインアウト
         *-------------------------------------------------------------------
         */
        get('#signout').addEventListener('click', () => {
            firebase.auth().signOut()
                .then(() => { })
                .catch(error => {
                    notice(info, error.code, error.message)
                })
        })

        /* 
         * change Auth state
         * AUTHステータス変更時のイベント
         *-------------------------------------------------------------------
         */
        firebase.auth().onAuthStateChanged(user => {

            // show signout button
            changeUi(user)
            changeUserInfo(user)

            if (user) {

            } else {

            }
        })

        /* 
         * chack signin type
         * いんぷっとのとこ
         *-------------------------------------------------------------------
         */
        get('#sign_email').addEventListener('keyup', event => {
            if (!firebase.auth().currentUser) {
                getSigninMethodsFromEmailAddress(event.target.value)
                    .then(result => {
                        // you can signin with password
                        get('#signin_password').disabled = !result.hasPassword
                        // you can signin with mail link
                        get('#signin_mail_link').disabled = !result.hasMailLink
                    })
            }
        })

        /* 
         * function
         * 他アカウントの統合メソッド
         *-------------------------------------------------------------------
         */
        function otherSignin(credential) {

            // 現在ログインしているユーザーへの参照を取得する
            const prevUser = firebase.auth().currentUser;

            // 別のアカウントでユーザーにログインする
            firebase.auth().signInWithCredential(credential)
                .then(nextUser => {
                    // console.log("Sign In Success", nextUser);

                    // const currentUser = otherUser
                    // Merge prevUser and currentUser data stored in Firebase.
                    // Note: How you handle this is specific to your application

                    // データの移行後、重複したユーザーを削除します
                    return nextUser.delete()
                        .then(result => {
                            // 元のアカウントにOAuthクレデンシャルをリンクする
                            return prevUser.linkWithCredential(credential)
                        })
                        .then(() => {
                            // 新しくリンクされたクレデンシャルでサインインする
                            return firebase.auth().signInWithCredential(credential);
                        })
                }).catch(error => {
                    notice(info, error.code, error.message)
                });
        }

        /* 
         * function
         * for change info
         *-------------------------------------------------------------------
         */
        function changeUserInfo(user) {
            if (user) {
                getSigninMethodsFromEmailAddress()
                    .then(providers => {
                        console.log(providers)
                        let providerStrings = []
                        Object.entries(providers).map(([key, value]) => ({ key, value })).forEach(provider => {
                            if (provider.value == true) {
                                providerStrings.push(provider.key)
                            }
                        })
                        get('.user_photo').src = user.photoURL || '/images/profile_placeholder.png'
                        get('.user_uid').textContent = user.uid || '---'
                        all('.user_display_name').forEach(element => {
                            element.textContent = user.displayName || '---'
                        })
                        all('.user_email').forEach(element => {
                            element.textContent = user.email || '---'
                        })
                        get('.user_email_verified').textContent = user.emailVerified || '---'
                        get('.user_creation_time').textContent = Date(user.metadata.creationTime) || '---'
                        get('.user_last_signin_time').textContent = Date(user.metadata.lastSignInTime) || '---'
                        get('.user_phone_number').textContent = user.phoneNumber || '---'
                        get('.user_photo_url').textContent = user.photoURL || '---'
                        get('.user_provider_data').textContent = providerStrings.join(', ') || '---'
                    })
                    .catch(error => {
                        notice(info, error.code, error.message)
                    })
            } else {
                get('.user_photo').src = ''
                get('.user_uid').textContent = '---'
                get('.user_display_name').textContent = '---'
                get('.user_email').textContent = '---'
                get('.user_email_verified').textContent = '---'
                get('.user_creation_time').textContent = '---'
                get('.user_last_signin_time').textContent = '---'
                get('.user_phone_number').textContent = '---'
                get('.user_photo_url').textContent = '---'
                get('.user_provider_data').textContent = '---'
            }
        }

        /* 
         * function
         * for change ui
         *-------------------------------------------------------------------
         */
        function changeUi(user) {

            get('#sign_email').value = ''
            get('#sign_password').value = ''
            get('#add_provider_mail').value = ''
            get('#add_provider_password').value = ''

            if (user) {
                // サインアウト開ける
                get('#signout').disabled = false
                // サインアウト閉める
                get('#signup').disabled = true
                // プロバイダサインインすべて閉める
                all('#sign_box .signin_provider').forEach(element => {
                    element.disabled = true
                })
                // メールインプット閉める
                get('#sign_email').disabled = true
                // パスワードインプット閉める
                get('#sign_password').disabled = true

                getSigninMethodsFromEmailAddress()
                    .then(providers => {
                        // add provider

                        get('#add_provider_mail').disabled = providers.hasPassword
                        get('#add_provider_password').disabled = providers.hasPassword
                        get('#add_provider_mail_password .add_provider').disabled = providers.hasPassword
                        get('#add_provider_mail_password .remove_provider').disabled = !providers.hasPassword
                        all('#add_google .add_provider').forEach(element => {
                            element.disabled = providers.hasGoogle
                        })
                        get('#add_google .remove_provider').disabled = !providers.hasGoogle

                        all('#add_facebook .add_provider').forEach(element => {
                            element.disabled = providers.hasFacebook
                        })
                        get('#add_facebook .remove_provider').disabled = !providers.hasFacebook

                        all('#add_github .add_provider').forEach(element => {
                            element.disabled = providers.hasGithub
                        })
                        get('#add_github .remove_provider').disabled = !providers.hasGithub

                        all('#add_twitter .add_provider').forEach(element => {
                            element.disabled = providers.hasTwitter
                        })
                        get('#add_twitter .remove_provider').disabled = !providers.hasTwitter
                        // resinin
                        get('#resignin_password').disabled = !providers.hasPassword
                        get('#resignin').disabled = !providers.hasPassword
                        all('#resignin_google .resignin_provider').forEach(element => {
                            element.disabled = !providers.hasGoogle
                        })
                        all('#resignin_facebook .resignin_provider').forEach(element => {
                            element.disabled = !providers.hasFacebook
                        })
                        all('#resignin_github .resignin_provider').forEach(element => {
                            element.disabled = !providers.hasGithub
                        })
                        all('#resignin_twitter .resignin_provider').forEach(element => {
                            element.disabled = !providers.hasTwitter
                        })
                    })
            } else {
                get('#signout').disabled = true
                get('#signup').disabled = false
                // プロバイダサインインすべて開ける
                all('#sign_box .signin_provider').forEach(element => {
                    element.disabled = false
                })
                // メールインプット開ける
                get('#sign_email').disabled = false
                // パスワードインプット開ける
                get('#sign_password').disabled = false

                // アドプロバイダを閉める
                all('#add_provider button, #add_provider input').forEach(element => {
                    element.disabled = true
                })
                // 再サインインを閉める
                all('#resign_box button, #resign_box input').forEach(element => {
                    element.disabled = true
                })
            }
        }

        /* 
         * function
         * chack signin method
         *-------------------------------------------------------------------
         */
        async function getSigninMethodsFromEmailAddress(emailAddress = null) {
            const user = firebase.auth().currentUser
            let result = {
                hasPassword: false,
                hasMailLink: false,
                hasGoogle: false,
                hasFacebook: false,
                hasGithub: false,
                hasTwitter: false
            }
            const email = user && user.email ? user.email : emailAddress
            if (email) {
                await firebase.auth().fetchSignInMethodsForEmail(email)
                    .then(providers => {
                        // パスワード、メイルリンクはどちらかのみ。
                        // 両方のときはメールアドレスを追加？
                        const signinPassword = firebase.auth.EmailAuthProvider.EMAIL_PASSWORD_SIGN_IN_METHOD
                        const signinMailLink = firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD
                        result.hasPassword = providers.includes(signinPassword)
                        result.hasMailLink = providers.includes(signinMailLink)
                    })
                    .catch(error => {
                        return error
                    })
            }
            if (user) {
                let providers = []
                user.providerData.forEach(provider => {
                    providers.push(provider.providerId)
                })
                result.hasGoogle = providers.includes("google.com")
                result.hasFacebook = providers.includes("facebook.com")
                result.hasGithub = providers.includes("github.com")
                result.hasTwitter = providers.includes("twitter.com")
            }
            return result
        }

        /* 
         * function
         * notice
         *-------------------------------------------------------------------
         */
        function notice(elem, title, message) {
            elem.innerHTML = `<h2>${title}</h2>
            <div>${message}</div>`
            setTimeout(() => {
                elem.innerHTML = ''
            }, 10000)
        }

        /* 
         * function
         * get element
        *-------------------------------------------------------------------
        */
        function get(elem) {
            return document.querySelector(elem)
        }

        function all(elems) {
            return document.querySelectorAll(elems)
        }
    </script>
</body>

</html>