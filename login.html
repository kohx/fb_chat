<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Sample FirebaseUI App</title>
    <!-- <script src="https://www.gstatic.com/firebasejs/5.0.3/firebase.js"></script> -->
    <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>

    <style>
        #info {
            padding: .6rem;
            margin: 10px 0;
            border: 1px solid silver;
        }

        #info h2 {
            font-size: 1rem;
            font-weight: bold;
            padding: 0;
            margin: 0;
        }

        .user_box {
            border: 1px solid silver;
            font-size: 0.6rem;
            padding: 0.6rem;
            margin: 0;
        }

        .user_title {
            font-weight: bold;
        }

        #input_box,
        #signin_box,
        #add_box {
            border: 1px solid silver;
            margin: 10px 0;
            padding: .6rem;
        }

        #add_google,
        #add_facebook,
        #add_github,
        #add_twitter,
        #signin_google,
        #signin_facebook,
        #signin_github,
        #signin_twitter {
            display: flex;
        }

        button,
        input {
            flex: 1;
            margin: 1px;
        }
    </style>
</head>

<body>

    <div>
        <img class="user_photo" height="30">
        <button type="button" id="signout" disabled>signout</button>
        <div id="info"></div>
    </div>

    <div id="input_box">
        <input id="email" type="email" placeholder="email">
        <input id="password" type="password" placeholder="password">
        <button type="button" id="signin" disabled>signin</button>
        <button type="button" id="signup">signup</button>
        <button type="button" id="signup_mail_link" disabled>signup mail link</button>
    </div>

    <div>sign in with provider</div>
    <div id="signin_box">
        <div id="signin_google">
            <button type="button" class="signin_provider" data-provider="google" data-action="popup" disabled>google popup</button>
            <button type="button" class="signin_provider" data-provider="google" data-action="redirect" disabled>google redirect</button>
        </div>
        <div id="signin_facebook">
            <button type="button" class="signin_provider" data-provider="facebook" data-action="popup" disabled>facebook popup</button>
            <button type="button" class="signin_provider" data-provider="facebook" data-action="redirect" disabled>facebook redirect</button>
        </div>
        <div id="signin_github">
            <button type="button" class="signin_provider" data-provider="github" data-action="popup" disabled>github popup</button>
            <button type="button" class="signin_provider" data-provider="github" data-action="redirect" disabled>github redirect</button>
        </div>
        <div id="signin_twitter">
            <button type="button" class="signin_provider" data-provider="twitter" data-action="popup" disabled>twitter popup</button>
            <button type="button" class="signin_provider" data-provider="twitter" data-action="redirect" disabled>twitter redirect</button>
        </div>
    </div>

    <div>add sign in provider</div>
    <div id="add_box">
        <div id="add_mail_password">
            <div style="display: flex;">
                <input id="mail_password_address" type="email" placeholder="email">
                <input id="mail_password_password" type="password" placeholder="password">
            </div>
            <div style="display: flex;">
                <button type="button" class="add_provider" data-provider="password" data-action="" disabled>mail link add</button>
                <button type="button" class="remove_provider" data-provider="password" data-action="" disabled>mail link remove</button>
            </div>
        </div>
        <div id="add_google" style="display: flex;">
            <button type="button" class="add_provider" data-provider="google.com" data-action="popup" disabled>google popup</button>
            <button type="button" class="add_provider" data-provider="google.com" data-action="redirect" disabled>google redirect</button>
            <button type="button" class="remove_provider" data-provider="google.com" data-action="redirect" disabled>google remove</button>
        </div>
        <div id="add_facebook" style="display: flex;">
            <button type="button" class="add_provider" data-provider="facebook.com" data-action="popup" disabled>facebook popup</button>
            <button type="button" class="add_provider" data-provider="facebook.com" data-action="redirect" disabled>facebook redirect</button>
            <button type="button" class="remove_provider" data-provider="facebook.com" data-action="redirect" disabled>facebook remove</button>
        </div>
        <div id="add_github" style="display: flex;">
            <button type="button" class="add_provider" data-provider="github.com" data-action="popup" disabled>github popup</button>
            <button type="button" class="add_provider" data-provider="github.com" data-action="redirect" disabled>github redirect</button>
            <button type="button" class="remove_provider" data-provider="github.com" data-action="redirect" disabled>github remove</button>
        </div>
        <div id="add_twitter" style="display: flex;">
            <button type="button" class="add_provider" data-provider="twitter.com" data-action="popup" disabled>twitter popup</button>
            <button type="button" class="add_provider" data-provider="twitter.com" data-action="redirect" disabled>twitter redirect</button>
            <button type="button" class="remove_provider" data-provider="twitter.com" data-action="redirect" disabled>twitter remove</button>
            <br>
        </div>
    </div>

    <button type="button" id="test">test</button>

    <div class="user_box">
        <div class="user_title">uid</div>
        <div class="user_value user_uid"></div>
        <div class="user_title">user_displayName</div>
        <div class="user_value user_displayName"></div>
        <div class="user_title">user_email</div>
        <div class="user_value user_email"></div>
        <div class="user_title">user_email_verified</div>
        <div class="user_value user_email_verified"></div>
        <div class="user_title">user_creation_time</div>
        <div class="user_value user_creation_time"></div>
        <div class="user_title">user_last_signin_time</div>
        <div class="user_value user_last_signin_time"></div>
        <div class="user_title">user_phone_number</div>
        <div class="user_value user_phone_number"></div>
        <div class="user_title">user_photo_url</div>
        <div class="user_value user_photo_url"></div>
        <div class="user_title">user_provider_data</div>
        <div class="user_value user_provider_data"></div>
    </div>

    <script type="text/javascript">
        // Initialize Firebase
        const config = {
            apiKey: "AIzaSyC_DO9wHhHtZ0Ei7BtmM7mLcMG-4h0rx-I",
            authDomain: "freindlychat-16c81.firebaseapp.com",
            databaseURL: "https://freindlychat-16c81.firebaseio.com",
            projectId: "freindlychat-16c81",
            storageBucket: "freindlychat-16c81.appspot.com",
            messagingSenderId: "743147525524"
        };
        firebase.initializeApp(config)

        // elements
        const info = document.querySelector('#info')
        const test = document.querySelector('#test')

        // Language setting
        firebase.auth().languageCode = 'ja'
        // firebase.auth().useDeviceLanguage()

        /* 
         * sign up
         * サインアップ
         *-------------------------------------------------------------------
         */
        get('#signup').addEventListener('click', () => {
            const email = document.querySelector('#email').value
            const password = document.querySelector('#password').value
            // sign up
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then(user => { })
                .catch(error => {
                    notice(info, error.code, error.message)
                })
        })

        /* 
         * sign in
         * サインイン
         *-------------------------------------------------------------------
         */
        get('#signin').addEventListener('click', () => {
            const email = document.querySelector('#email').value
            const password = document.querySelector('#password').value

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(user => { })
                .catch(error => {
                    notice(info, error.code, error.message)
                })
        })

        /* 
         * signin with mail [send]
         * メールとパスワードでサインイン
         *-------------------------------------------------------------------
         */
        const actionCodeSettings = {
            // URL you want to redirect back to. The domain (www.example.com) for this
            // URL must be whitelisted in the Firebase Console.
            url: 'http://localhost:5000/login.html',
            // This must be true.
            handleCodeInApp: true
        }

        get('#signup_mail_link').addEventListener('click', event => {
            const email = document.querySelector('#email').value
            const password = document.querySelector('#password').value
            firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    // The link was successfully sent. Inform the user.
                    // Save the email locally so you don't need to ask the user for it again
                    // if they open the link on the same device.
                    window.localStorage.setItem('emailForSignIn', email);
                    notice(info, 'info', 'email for sign in seved.<br>check your email and click signin url.')
                })
                .catch(error => {
                    notice(info, error.code, error.message)
                })
        })

        /* 
         * receive then signin with mail and password
         * メールとパスワードでサインインした場合の受け
         *-------------------------------------------------------------------
         */

        // Confirm the link is a sign-in with email link.
        if (firebase.auth().isSignInWithEmailLink(window.location.href)) {

            let emailForSignIn = window.localStorage.getItem('emailForSignIn');

            // if emailForSignIn is not in localstorage, ask email to user
            if (!emailForSignIn) {

                emailForSignIn = window.prompt('Please provide your email for confirmation');
            }

            firebase.auth().signInWithEmailLink(emailForSignIn, window.location.href)
                .then(result => {
                    // Clear email from storage.
                    window.localStorage.removeItem('emailForSignIn');

                    // result
                    const isNewUser = result.additionalUserInfo.isNewUser
                    const providerId = result.additionalUserInfo.providerId
                    const credentialcredential = result.credentialcredential
                    const operationType = result.operationType
                    const user = result.user
                    console.log(isNewUser)
                    console.log(providerId)
                    console.log(credentialcredential)
                    console.log(operationType)
                    console.log(user)
                })
                .catch(error => {
                    notice(info, error.code, error.message)
                })
        }

        /* 
         * signin with social media provider
         * ソーシャルメディアプロバイダでサインイン
         *-------------------------------------------------------------------
         */
        all('.signin_provider').forEach(signinProvider => {
            signinProvider.addEventListener('click', event => {
                const target = event.target.dataset
                let provider = null
                switch (target.provider) {
                    case 'google':
                        provider = new firebase.auth.GoogleAuthProvider()
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'login_hint': 'user@example.com'
                        })
                        break;

                    case 'facebook':
                        provider = new firebase.auth.FacebookAuthProvider();
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'display': 'popup'
                        });
                        break;

                    case 'github':
                        provider = new firebase.auth.GithubAuthProvider();
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'allow_signup': 'false'
                        })
                        break;

                    case 'twitter':
                        provider = new firebase.auth.TwitterAuthProvider();
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'lang': 'ja'
                        });
                        break;

                    default:
                        break;
                }

                if (target.action == 'popup') {
                    firebase.auth().signInWithPopup(provider)
                        .then(result => {
                            // This gives you a Google Access Token. You can use it to access the Google API.
                            const token = result.credential.accessToken;
                            const user = result.user;
                            const credential = result.credential;
                            console.log(token)
                            console.log(user)
                            console.log(credential)
                        })
                        .catch(error => {
                            notice(info, error.code, error.message)
                            console.log(error.email)
                            console.log(error.credential)
                        })
                }

                if (target.action == 'redirect') {
                    firebase.auth().signInWithRedirect(provider)
                }
            })
        })

        /* 
         * add social media provider
         * ソーシャルメディアプロバイダ追加
         *-------------------------------------------------------------------
         */
        all('.add_provider').forEach(addProvider => {
            addProvider.addEventListener('click', event => {
                const currentUser = firebase.auth().currentUser
                const target = event.target.dataset
                let provider = null
                switch (target.provider) {
                    case 'google.com':
                        provider = new firebase.auth.GoogleAuthProvider()
                        break;
                    case 'facebook.com':
                        provider = new firebase.auth.FacebookAuthProvider();
                        break;
                    case 'github.com':
                        provider = new firebase.auth.GithubAuthProvider();
                        break;
                    case 'twitter.com':
                        provider = new firebase.auth.TwitterAuthProvider();
                        break;
                    default:
                        break;
                }

                if (target.action == 'popup') {
                    currentUser.linkWithPopup(provider)
                        .then(result => {
                            const token = result.credential.accessToken;
                            const user = result.user;
                            const credential = result.credential;
                            console.log(token)
                            console.log(user)
                            console.log(credential)

                            changeUi(user)
                            changeUserInfo(user)
                        })
                        .catch(error => {
                            if (error.credential) {

                                // 他アカウントの統合メソッドを呼び出し
                                otherSignin(error.credential)
                            } else {
                                notice(info, error.code, error.message)
                            }
                        })
                }

                if (target.action == 'redirect') {
                    currentUser.linkWithRedirect(provider)
                }
            })
        })

        /* 
         * recieve then signin with social media provider
         * recieve then sdd social media provider
         * ソーシャルメディアプロバイダでサインインした場合の受け
         * ソーシャルメディアプロバイダ追加した場合の受け
         *-------------------------------------------------------------------
         */
        firebase.auth().getRedirectResult()
            .then(result => {
                if (result.credential) {
                    const token = result.credential.accessToken;
                    const user = result.user;
                    const credential = result.credential;
                    console.log(token)
                    console.log(user)
                    console.log(credential)
                }
            })
            .catch(error => {
                if (error.credential) {

                    // 他アカウントの統合メソッドを呼び出し
                    otherSignin(error.credential)
                } else {
                    notice(info, error.code, error.message)
                }
            })

        /* 
         * add mail-password provider
         * メイルパスワードプロバイダ追加
         *-------------------------------------------------------------------
         */
        get('#add_mail_password .add_provider').addEventListener('click', event => {
            const currentUser = firebase.auth().currentUser
            if (!currentUser) {
                return
            }
            const email = document.querySelector('#mail_password_address').value
            const password = document.querySelector('#mail_password_password').value

            // get credential
            const credential = firebase.auth.EmailAuthProvider.credential(email, password)
            currentUser.linkAndRetrieveDataWithCredential(credential)
                .then(result => {
                    const token = result.credential.accessToken;
                    const user = result.user;
                    const credential = result.credential;
                    console.log(token)
                    console.log(user)
                    console.log(credential)
                    changeUi(result.user)
                    changeUserInfo(result.user)
                })
                .catch(error => {
                    if (error.credential) {

                        // 他アカウントの統合メソッドを呼び出し
                        otherSignin(error.credential)
                    } else {
                        notice(info, error.code, error.message)
                    }
                })
        })

        /* 
         * remove provider link
         * プロバイダのリムーブ
         *-------------------------------------------------------------------
         */
        all('.remove_provider').forEach(removeProvdier => {
            removeProvdier.addEventListener('click', event => {
                const currentUser = firebase.auth().currentUser
                const providerId = event.target.dataset.provider
                // give provider id
                currentUser.unlink(providerId)
                    .then(user => {
                        changeUi(user)
                        changeUserInfo(user)
                    })
                    .catch(error => {
                        notice(info, error.code, error.message)
                        console.log(error.email)
                        console.log(error.credential)
                    })
            })
        })

        /* 
         * sign out
         * サインアウト
         *-------------------------------------------------------------------
         */
        get('#signout').addEventListener('click', () => {
            firebase.auth().signOut()
                .then(() => { })
                .catch(error => {
                    notice(info, error.code, error.message)
                })
        })

        /* 
         * chack signin type
         * いんぷっとのとこ
         *-------------------------------------------------------------------
         */
        email.addEventListener('keyup', event => {
            getSigninMethodsFromEmailAddress(event.target.value)
                .then(result => {
                    console.log(result)
                    get('#signup_mail_link').disabled = result.hasMailLink

                    all('#signin_google .signin_provider').array.forEach(element => {
                        element.disabled = result.hasGoogle
                    });
                    all('#signin_facebook .signin_provider').array.forEach(element => {
                        element.disabled = result.hasFacebook
                    });
                    all('#signin_github .signin_provider').array.forEach(element => {
                        element.disabled = result.hasGithub
                    });
                    all('#signin_twitter .signin_provider').array.forEach(element => {
                        element.disabled = result.hasTwitter
                    });

                    if (result.hasPssword) {
                        get('#signup').disabled = false
                    } else {
                        get('#signup').disabled = true
                    }
                })
                .catch(error => {
                    console.log('inputting...')
                })
        })

        /* 
         * change Auth state
         * AUTHステータス変更時のイベント
         *-------------------------------------------------------------------
         */
        firebase.auth().onAuthStateChanged(user => {

            // show signout button
            changeUi(user)
            changeUserInfo(user)

            if (user) {
                console.log(user)
            } else {

            }
        })

        /* 
         * function
         * 他アカウントの統合メソッド
         *-------------------------------------------------------------------
         */
        function otherSignin(credential) {

            // 現在ログインしているユーザーへの参照を取得する
            const prevUser = firebase.auth().currentUser;

            // 別のアカウントでユーザーにログインする
            firebase.auth().signInWithCredential(credential)
                .then(nextUser => {
                    // console.log("Sign In Success", nextUser);

                    // const currentUser = otherUser
                    // Merge prevUser and currentUser data stored in Firebase.
                    // Note: How you handle this is specific to your application

                    // データの移行後、重複したユーザーを削除します
                    return nextUser.delete()
                        .then(result => {
                            // 元のアカウントにOAuthクレデンシャルをリンクする
                            return prevUser.linkWithCredential(credential)
                        })
                        .then(() => {
                            // 新しくリンクされたクレデンシャルでサインインする
                            return firebase.auth().signInWithCredential(credential);
                        })
                }).catch(error => {
                    notice(info, error.code, error.message)
                });
        }

        /* 
         * function
         * for change ui
         *-------------------------------------------------------------------
         */
        function changeUserInfo(user) {
            if (user) {
                let providers = []
                const methods = getSigninMethodsFromCurrentUser(user)
                const methodObj = (Object.entries(methods).map(([key, value]) => ({ key, value })))
                methodObj.forEach(provider => {
                    if (provider.value == true) {
                        providers.push(provider.key)
                    }
                });
                get('.user_photo').src = user.photoURL || 'none'
                get('.user_uid').textContent = user.uid || 'none'
                get('.user_displayName').textContent = user.displayName || 'none'
                get('.user_email').textContent = user.email || 'none'
                get('.user_email_verified').textContent = user.emailVerified || 'none'
                get('.user_creation_time').textContent = Date(user.metadata.creationTime) || 'none'
                get('.user_last_signin_time').textContent = Date(user.metadata.lastSignInTime) || 'none'
                get('.user_phone_number').textContent = user.phoneNumber || 'none'
                get('.user_photo_url').textContent = user.photoURL || 'none'
                get('.user_provider_data').textContent = providers || 'none'
            } else {
                get('.user_photo').src = ''
                get('.user_uid').textContent = '---'
                get('.user_displayName').textContent = '---'
                get('.user_email').textContent = '---'
                get('.user_email_verified').textContent = '---'
                get('.user_creation_time').textContent = '---'
                get('.user_last_signin_time').textContent = '---'
                get('.user_phone_number').textContent = '---'
                get('.user_photo_url').textContent = '---'
                get('.user_provider_data').textContent = '---'
            }
        }

        /* 
         * function
         * for change ui
         *-------------------------------------------------------------------
         */
        function changeUi(user) {
            email.value = ''
            password.value = ''
            if (user) {

                // show signout button
                get('#signin').disabled = false
                get('#signout').disabled = false
                get('#signup').disabled = true

                // hide signin with provider
                all('.signin_provider').forEach(element => {
                    element.disabled = true
                })

                // hide provider add
                const methods = getSigninMethodsFromCurrentUser(user)
                console.log(methods)

                get('#mail_password_address').disabled = methods.hasPssword
                get('#mail_password_password').disabled = methods.hasPssword
                get('#add_mail_password .add_provider').disabled = methods.hasPssword
                get('#add_mail_password .remove_provider').disabled = !methods.hasPssword

                all('#add_google .add_provider').forEach(element => {
                    element.disabled = methods.hasGoogle
                })
                get('#add_google .remove_provider').disabled = !methods.hasGoogle

                all('#add_facebook .add_provider').forEach(element => {
                    element.disabled = methods.hasFacebook
                })
                get('#add_facebook .remove_provider').disabled = !methods.hasFacebook

                all('#add_github .add_provider').forEach(element => {
                    element.disabled = methods.hasGithub
                })
                get('#add_github .remove_provider').disabled = !methods.hasGithub

                all('#add_twitter .add_provider').forEach(element => {
                    element.disabled = methods.hasTwitter
                })
                get('#add_twitter .remove_provider').disabled = !methods.hasTwitter

                // location.href = 'index.html'
            } else {
                get('#signin').disabled = false
                get('#signup').disabled = false
                get('#signout').disabled = true

                all('.signin_provider').forEach(element => {
                    element.disabled = false
                })

                all('.add_provider').forEach(element => {
                    element.disabled = true
                })

                all('.remove_provider').forEach(element => {
                    element.disabled = true
                })
            }
        }

        /* 
         * function
         * chack signin method from current user
         *-------------------------------------------------------------------
         */
        function getSigninMethodsFromCurrentUser(user) {
            if (user) {
                const signinPassword = firebase.auth.EmailAuthProvider.EMAIL_PASSWORD_SIGN_IN_METHOD
                const signinMailLink = firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD
                let signInMethods = [];
                user.providerData.forEach(value => {
                    signInMethods.push(value.providerId)
                })
                return {
                    hasPssword: signInMethods.indexOf(signinPassword) != -1,
                    hasMailLink: signInMethods.indexOf(signinMailLink) != -1,
                    hasGoogle: signInMethods.indexOf("google.com") != -1,
                    hasFacebook: signInMethods.indexOf("facebook.com") != -1,
                    hasGithub: signInMethods.indexOf("github.com") != -1,
                    hasTwitter: signInMethods.indexOf("twitter.com") != -1
                }
            }
            return {
                hasPssword: false,
                hasMailLink: false,
                hasGoogle: false,
                hasFacebook: false,
                hasMailLink: false,
                hasMailLink: false
            }
        }

        /* 
         * function
         * chack signin method
         *-------------------------------------------------------------------
         */
        function getSigninMethodsFromEmailAddress(emailAddress) {
            return new Promise((resolve, reject) => {
                firebase.auth().fetchSignInMethodsForEmail(emailAddress)
                    .then(signInMethods => {
                        const signinPassword = firebase.auth.EmailAuthProvider.EMAIL_PASSWORD_SIGN_IN_METHOD
                        const signinMailLink = firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD
                        resolve({
                            hasPssword: signInMethods.indexOf(signinPassword) != -1,
                            hasMailLink: signInMethods.indexOf(signinMailLink) != -1,
                            hasGoogle: signInMethods.indexOf("google.com") != -1,
                            hasFacebook: signInMethods.indexOf("facebook.com") != -1,
                            hasGithub: signInMethods.indexOf("github.com") != -1,
                            hasTwitter: signInMethods.indexOf("twitter.com") != -1
                        })
                    })
                    .catch(error => {
                        reject({
                            hasPssword: false,
                            hasMailLink: false,
                            hasGoogle: false,
                            hasFacebook: false,
                            hasMailLink: false,
                            hasMailLink: false
                        })
                    })
            });
        }

        /* 
         * function
         * notice
         *-------------------------------------------------------------------
         */
        function notice(elem, title, message) {
            elem.innerHTML = `<h2>${title}</h2>
            <div>${message}</div>`
            setTimeout(() => {
                elem.innerHTML = ''
            }, 10000)
        }

        /* 
         * function
         * get element
        *-------------------------------------------------------------------
        */
        function get(elem) {
            return document.querySelector(elem)
        }

        function all(elems) {
            return document.querySelectorAll(elems)
        }
    </script>
</body>

</html>