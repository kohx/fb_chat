<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Sample FirebaseUI App</title>
    <script src="https://www.gstatic.com/firebasejs/5.0.3/firebase.js"></script>
</head>

<body>
    <button type="button" id="check_signin">check signin</button>
    <div id="sign"></div>
    <input id="email" type="email">
    <input id="password" type="password">
    <button type="button" id="signup">signup</button>
    <button type="button" id="signin" disabled>signin</button>
    <button type="button" id="signout" disabled>signout</button>
    <button type="button" id="signup_mail_link" disabled>signup mail link</button>

    <div id="signin_box" style="border: 1px solid silver; padding: 10px; margin: 10px 0;">
        <div id="signin_google">
            <button type="button" class="signin_provider" data-provider="google" data-action="popup">google popup</button>
            <button type="button" class="signin_provider" data-provider="google" data-action="redirect">google redirect</button>
        </div>
        <div id="signin_facebook">
            <button type="button" class="signin_provider" data-provider="facebook" data-action="popup">facebook popup</button>
            <button type="button" class="signin_provider" data-provider="facebook" data-action="redirect">facebook redirect</button>
        </div>
        <div id="signin_github">
            <button type="button" class="signin_provider" data-provider="github" data-action="popup">github popup</button>
            <button type="button" class="signin_provider" data-provider="github" data-action="redirect">github redirect</button>
        </div>
        <div id="signin_twitter">
            <button type="button" class="signin_provider" data-provider="twitter" data-action="popup">twitter popup</button>
            <button type="button" class="signin_provider" data-provider="twitter" data-action="redirect">twitter redirect</button>
        </div>
    </div>

    <div id="add_box" style="border: 1px solid silver; padding: 10px; margin: 10px 0;">
        <div id="add_google">
            <button type="button" class="add_provider" data-provider="google" data-action="popup">google popup</button>
            <button type="button" class="add_provider" data-provider="google" data-action="redirect">google redirect</button>
        </div>
        <div id="add_facebook">
            <button type="button" class="add_provider" data-provider="facebook" data-action="popup">facebook popup</button>
            <button type="button" class="add_provider" data-provider="facebook" data-action="redirect">facebook redirect</button>
        </div>
        <div id="add_github">
            <button type="button" class="add_provider" data-provider="github" data-action="popup">github popup</button>
            <button type="button" class="add_provider" data-provider="github" data-action="redirect">github redirect</button>
        </div>
        <div id="add_twitter">
            <button type="button" class="add_provider" data-provider="twitter" data-action="popup">twitter popup</button>
            <button type="button" class="add_provider" data-provider="twitter" data-action="redirect">twitter redirect</button>
            <br>
        </div>
    </div>

    <button type="button" id="test">test</button>

    <script type="text/javascript">
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyC_DO9wHhHtZ0Ei7BtmM7mLcMG-4h0rx-I",
            authDomain: "freindlychat-16c81.firebaseapp.com",
            databaseURL: "https://freindlychat-16c81.firebaseio.com",
            projectId: "freindlychat-16c81",
            storageBucket: "freindlychat-16c81.appspot.com",
            messagingSenderId: "743147525524"
        };
        firebase.initializeApp(config)

        const sign = document.querySelector('#sign')
        const signup = document.querySelector('#signup')
        const signin = document.querySelector('#signin')
        const signout = document.querySelector('#signout')

        const checkSignin = document.querySelector('#check_signin')
        const signupMailLink = document.querySelector('#signup_mail_link')

        const signinBox = document.querySelector('#signin_box')
        const signinProviders = document.querySelectorAll('.signin_provider')

        const addBox = document.querySelector('#add_box')
        const addProviders = document.querySelectorAll('.add_provider')

        const test = document.querySelector('#test')

        firebase.auth().languageCode = 'ja'
        // firebase.auth().useDeviceLanguage()

        test.addEventListener('click', event => {
            alert('test!')
        })


        /* 
         * 
         *-------------------------------------------------------------------
         */
        all('.add_provider').forEach(addProvider => {
            addProvider.addEventListener('click', event => {
                const currentUser = firebase.auth().currentUser
                const target = event.target.dataset
                let provider = null
                switch (target.provider) {
                    case 'google':
                        provider = new firebase.auth.GoogleAuthProvider()
                        break;

                    case 'facebook':
                        provider = new firebase.auth.FacebookAuthProvider();
                        break;

                    case 'github':
                        provider = new firebase.auth.GithubAuthProvider();
                        break;

                    case 'twitter':
                        provider = new firebase.auth.TwitterAuthProvider();
                        break;

                    default:
                        break;
                }

                if (target.action == 'popup') {
                    currentUser.linkWithPopup(provider)
                        .then(result => {
                            notice(sign, 'info', "Facebookアカウントのリンクに成功しました。Facebookアカウントでログインできるようになりました")
                            var token = result.credential.accessToken;
                            var user = result.user;
                            var credential = result.credential;
                            console.log(token)
                            console.log(user)
                            console.log(credential)

                            changeUi(user)
                        }, error => {
                            notice(sign, error.code, error.message)
                            console.log(error.email)
                            console.log(error.credential)
                        })
                }

                if (target.action == 'redirect') {
                    firebase.auth().linkWithRedirect(provider)
                }
            })
        })

        /* 
         * sign up
         *-------------------------------------------------------------------
         */
        signup.addEventListener('click', () => {
            const email = document.querySelector('#email').value
            const password = document.querySelector('#password').value
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then(user => { })
                .catch(
                    error => {
                        console.log(error.code)
                        console.log(error.message)
                    })
        })

        /* 
         * sign in
         *-------------------------------------------------------------------
         */
        signin.addEventListener('click', () => {
            const email = document.querySelector('#email').value
            const password = document.querySelector('#password').value

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(user => { })
                .catch(
                    error => {
                        console.log(error.code)
                        console.log(error.message)
                    })
        })

        /* 
         * signin with mail
         *-------------------------------------------------------------------
         */
        var actionCodeSettings = {
            // URL you want to redirect back to. The domain (www.example.com) for this
            // URL must be whitelisted in the Firebase Console.
            url: 'http://localhost:5000/login.html',
            // This must be true.
            handleCodeInApp: true
        }

        signupMailLink.addEventListener('click', event => {
            const email = document.querySelector('#email').value
            const password = document.querySelector('#password').value
            firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    // The link was successfully sent. Inform the user.
                    // Save the email locally so you don't need to ask the user for it again
                    // if they open the link on the same device.
                    window.localStorage.setItem('emailForSignIn', email);
                    notice(sign, 'info', 'email for sign in seved.<br>check your email and click signin url.')
                }, error => {
                    notice(sign, error.code, error.message)
                });
        })

        /* 
         * receive signin with mail
         *-------------------------------------------------------------------
         */
        // Confirm the link is a sign-in with email link.
        if (firebase.auth().isSignInWithEmailLink(window.location.href)) {

            let emailForSignIn = window.localStorage.getItem('emailForSignIn');

            // if emailForSignIn is not in localstorage, ask email to user
            if (!emailForSignIn) {

                emailForSignIn = window.prompt('Please provide your email for confirmation');
            }

            firebase.auth().signInWithEmailLink(emailForSignIn, window.location.href)
                .then(function (result) {
                    // Clear email from storage.
                    window.localStorage.removeItem('emailForSignIn');

                    // result
                    const isNewUser = result.additionalUserInfo.isNewUser
                    const providerId = result.additionalUserInfo.providerId
                    const credentialcredential = result.credentialcredential
                    const operationType = result.operationType
                    const user = result.user
                    console.log(isNewUser)
                    console.log(providerId)
                    console.log(credentialcredential)
                    console.log(operationType)
                    console.log(user)
                }, error => {
                    notice(sign, error.code, error.message)
                });
        }

        /* 
         * signin with provider
         *-------------------------------------------------------------------
         */
        signinProviders.forEach(signinProvider => {
            signinProvider.addEventListener('click', event => {
                const target = event.target.dataset
                let provider = null
                switch (target.provider) {
                    case 'google':
                        provider = new firebase.auth.GoogleAuthProvider()
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'login_hint': 'user@example.com'
                        })
                        break;

                    case 'facebook':
                        provider = new firebase.auth.FacebookAuthProvider();
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'display': 'popup'
                        });
                        break;

                    case 'github':
                        provider = new firebase.auth.GithubAuthProvider();
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'allow_signup': 'false'
                        })
                        break;

                    case 'twitter':
                        provider = new firebase.auth.TwitterAuthProvider();
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'lang': 'ja'
                        });
                        break;

                    default:
                        break;
                }

                if (target.action == 'popup') {
                    firebase.auth().signInWithPopup(provider)
                        .then(result => {
                            // This gives you a Google Access Token. You can use it to access the Google API.
                            var token = result.credential.accessToken;
                            var user = result.user;
                            var credential = result.credential;
                            console.log(token)
                            console.log(user)
                            console.log(credential)
                        }, error => {
                            notice(sign, error.code, error.message)
                            console.log(error.email)
                            console.log(error.credential)
                        })
                }

                if (target.action == 'redirect') {
                    firebase.auth().signInWithRedirect(provider)
                }
            })
        })

        /* 
         * redirect receive
         */
        firebase.auth().getRedirectResult()
            .then(result => {
                if (result.credential) {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    var token = result.credential.accessToken;
                    var user = result.user;
                    var credential = result.credential;
                    console.log(token)
                    console.log(user)
                    console.log(uscredentialer)
                }
            }).catch(function (error) {
                notice(sign, error.code, error.message)
                console.log(error.email)
                console.log(error.credential)
            });

        /* 
         * sign out
         *-------------------------------------------------------------------
         */
        signout.addEventListener('click', () => {
            firebase.auth().signOut()
                .then(() => {
                    sign.innerHTML = 'signout!'
                }, error => {
                    notice(sign, error.code, error.message)
                })
        })

        /* 
         * chack signin type
         *-------------------------------------------------------------------
         */
        email.addEventListener('keyup', event => {
            getSigninMethodsFromEmailAddress(event.target.value)
                .then(result => {
                    console.log(result)
                    signin.disabled = result.hasPssword
                    signupMailLink.disabled = result.hasMailLink
                    signinGooglePopup = result.hasGoogle
                    signinGoogleRedirect = result.hasGoogle
                    signinFacebookPopup = result.hasFacebook
                    signinFacebookRedirect = result.hasFacebook
                    signinGithubPopup = result.hasGithub
                    signinGithubRedirect = result.hasGithub
                    signinhasTwitterPopup = result.hasTwitter
                    signinhasTwitterRedirect = result.hasTwitter

                    if (result.hasPssword) {
                        signup.disabled = false
                    } else {
                        signup.disabled = true
                    }
                })
                .catch(error => {
                    console.log('inputting...')
                })
        })

        /* 
         * check sign in
         *-------------------------------------------------------------------
         */
        checkSignin.addEventListener('click', event => {
            const currentUser = firebase.auth().currentUser;
            if (currentUser) {
                alert('user sign in!')
                console.log(currentUser)
                console.log(currentUser.displayName)
                console.log(currentUser.emailemail)
                console.log(currentUser.emailVerified)
                console.log(currentUser.metadata.creationTime)
                console.log(currentUser.metadata.lastSignInTime)
                console.log(currentUser.phoneNumber)
                console.log(currentUser.photoURL)
                console.log(currentUser.providerData)
            } else {
                alert('user not sign in!')
            }
        })

        /* 
         * change Auth state
         *-------------------------------------------------------------------
         */
        firebase.auth().onAuthStateChanged(user => {
            changeUi(user)

            if (user) {
                // show notice
                notice(sign, 'info', 'signin!')
                // show signout button
                changeUi

                // location.href = 'index.html'
            } else {
                notice(sign, 'info', 'not signin!')
            }
        })

        function changeUi(user) {
            if (user) {
                // show signout button
                signout.disabled = false
                // hide signin with provider
                all('.signin_provider').forEach(elment => {
                    elment.disabled = true
                })
                // hide provider add
                const methods = getSigninMethodsFromCurrentUser(user)
                all('#add_google .add_provider').forEach(elment => {
                    elment.disabled = methods.hasGoogle
                })
                all('#add_facebook .add_provider').forEach(elment => {
                    elment.disabled = methods.hasFacebook
                })
                all('#add_github .add_provider').forEach(elment => {
                    elment.disabled = methods.hasGithub
                })
                all('#add_twitter .add_provider').forEach(elment => {
                    elment.disabled = methods.hasTwitter
                })

                // location.href = 'index.html'
            } else {
                signout.disabled = true
                all('.signin_provider').forEach(elment => {
                    elment.disabled = false
                })

                all('.add_provider').forEach(elment => {
                    elment.disabled = true
                })
            }
        }

        /* 
         * chack signin method from current user
         *-------------------------------------------------------------------
         */
        function getSigninMethodsFromCurrentUser(currentUser = null) {
            if (!currentUser) {
                currentUser = firebase.auth().currentUser;
            }

            if (currentUser) {
                const signinPassword = firebase.auth.EmailAuthProvider.EMAIL_PASSWORD_SIGN_IN_METHOD
                const signinMailLink = firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD
                let signInMethods = [];
                currentUser.providerData.forEach(value => {
                    signInMethods.push(value.providerId)
                })
                return {
                    hasPssword: signInMethods.indexOf(signinPassword) != -1,
                    hasMailLink: signInMethods.indexOf(signinMailLink) != -1,
                    hasGoogle: signInMethods.indexOf("google.com") != -1,
                    hasFacebook: signInMethods.indexOf("facebook.com") != -1,
                    hasGithub: signInMethods.indexOf("github.com") != -1,
                    hasTwitter: signInMethods.indexOf("twitter.com") != -1
                }
            }

            return {
                hasPssword: false,
                hasMailLink: false,
                hasGoogle: false,
                hasFacebook: false,
                hasMailLink: false,
                hasMailLink: false
            }
        }

        /* 
         * chack signin method
         *-------------------------------------------------------------------
         */
        function getSigninMethodsFromEmailAddress(emailAddress) {
            return new Promise((resolve, reject) => {
                firebase.auth().fetchSignInMethodsForEmail(emailAddress)
                    .then(signInMethods => {
                        const signinPassword = firebase.auth.EmailAuthProvider.EMAIL_PASSWORD_SIGN_IN_METHOD
                        const signinMailLink = firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD
                        resolve({
                            hasPssword: signInMethods.indexOf(signinPassword) != -1,
                            hasMailLink: signInMethods.indexOf(signinMailLink) != -1,
                            hasGoogle: signInMethods.indexOf("google.com") != -1,
                            hasFacebook: signInMethods.indexOf("facebook.com") != -1,
                            hasGithub: signInMethods.indexOf("github.com") != -1,
                            hasTwitter: signInMethods.indexOf("twitter.com") != -1
                        })
                    }, error => {
                        reject({
                            hasPssword: false,
                            hasMailLink: false,
                            hasGoogle: false,
                            hasFacebook: false,
                            hasMailLink: false,
                            hasMailLink: false
                        })
                    })
            });
        }

        /* 
         * notice
         *-------------------------------------------------------------------
         */
        function notice(elem, title, message) {
            elem.innerHTML = `<h2>${title}</h2>
            <p>${message}</p>`
        }
        /* 
        * get()
        *-------------------------------------------------------------------
        */
        function get(elem) {
            return document.querySelector(elem)
        }
        function all(elems) {
            return document.querySelectorAll(elems)
        }
    </script>
</body>

</html>