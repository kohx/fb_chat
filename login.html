<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Sample FirebaseUI App</title>
    <script src="https://www.gstatic.com/firebasejs/5.0.3/firebase.js"></script>
</head>

<body>
    <button type="button" id="check_signin">check signin</button>
    <div id="sign"></div>
    <input id="email" type="email">
    <input id="password" type="password">
    <button type="button" id="signup">signup</button>
    <button type="button" id="signin" disabled>signin</button>
    <button type="button" id="signout" disabled>signout</button>
    <button type="button" id="signup_mail_link" disabled>signup mail link</button>
    
    <div style="border: 1px solid silver; padding: 10px; margin: 10px 0;">
        <button type="button" id="signinGooglePopup" class="signin_provider" data-provider="google" data-action="popup">google popup</button>
        <br>
        <button type="button" id="signinGoogleRedirect" class="signin_provider" data-provider="google" data-action="redirect">google redirect</button>
        <br>
        <button type="button" class="signin_provider" data-provider="facebook" data-action="popup">facebook popup</button>
        <br>
        <button type="button" class="signin_provider" data-provider="facebook" data-action="redirect">facebook redirect</button>
        <br>
    </div>
    <div style="border: 1px solid silver; padding: 10px; margin: 10px 0;">
        <button type="button" class="add_provider" data-provider="google" data-action="popup">google popup</button>
        <br>
        <button type="button" class="add_provider" data-provider="google" data-action="redirect">google redirect</button>
        <br>
        <button type="button" class="add_provider" data-provider="facebook" data-action="popup">facebook popup</button>
        <br>
        <button type="button" class="add_provider" data-provider="facebook" data-action="redirect">facebook redirect</button>
        <br>
    </div>
    <button type="button" id="test">test</button>

    <script type="text/javascript">
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyC_DO9wHhHtZ0Ei7BtmM7mLcMG-4h0rx-I",
            authDomain: "freindlychat-16c81.firebaseapp.com",
            databaseURL: "https://freindlychat-16c81.firebaseio.com",
            projectId: "freindlychat-16c81",
            storageBucket: "freindlychat-16c81.appspot.com",
            messagingSenderId: "743147525524"
        };
        firebase.initializeApp(config)

        const sign = document.querySelector('#sign')
        const signup = document.querySelector('#signup')
        const signin = document.querySelector('#signin')
        const signout = document.querySelector('#signout')
        const checkSignin = document.querySelector('#check_signin')
        const signupMailLink = document.querySelector('#signup_mail_link')
        const signinProviders = document.querySelectorAll('.signin_provider')
        const addProviders = document.querySelectorAll('.add_provider')
        const test = document.querySelector('#test')

        firebase.auth().languageCode = 'ja'
        // firebase.auth().useDeviceLanguage()

        addProviders.forEach(addProvider => {
            addProvider.addEventListener('click', event => {
                const currentUser = firebase.auth().currentUser;
                console.log(currentUser)


                var provider = new firebase.auth.FacebookAuthProvider();

                currentUser.linkWithPopup(provider)
                    .then(function (result) {
                        // Accounts successfully linked.
                        var credential = result.credential;
                        var user = result.user;
                        alert("Facebookアカウントのリンクに成功しました。Facebookアカウントでログインできるようになりました")
                        // ...
                    }).catch(function (error) {
                        // Handle Errors here.
                        alert("Facebookアカウントのリンク中にエラーが発生しました")
                    });
            })
        })


        /* 
         * sign up
         *-------------------------------------------------------------------
         */
        signup.addEventListener('click', () => {
            const email = document.querySelector('#email').value
            const password = document.querySelector('#password').value
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then(user => { })
                .catch(
                    error => {
                        console.log(error.code)
                        console.log(error.message)
                    })
        })

        /* 
         * sign in
         *-------------------------------------------------------------------
         */
        signin.addEventListener('click', () => {
            const email = document.querySelector('#email').value
            const password = document.querySelector('#password').value

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(user => { })
                .catch(
                    error => {
                        console.log(error.code)
                        console.log(error.message)
                    })
        })

        /* 
         * signin with mail
         *-------------------------------------------------------------------
         */
        var actionCodeSettings = {
            // URL you want to redirect back to. The domain (www.example.com) for this
            // URL must be whitelisted in the Firebase Console.
            url: 'http://localhost:5000/login.html',
            // This must be true.
            handleCodeInApp: true
        }

        signupMailLink.addEventListener('click', event => {
            const email = document.querySelector('#email').value
            const password = document.querySelector('#password').value
            firebase.auth().sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    // The link was successfully sent. Inform the user.
                    // Save the email locally so you don't need to ask the user for it again
                    // if they open the link on the same device.
                    window.localStorage.setItem('emailForSignIn', email);
                    notice(sign, 'info', 'email for sign in seved.<br>check your email and click signin url.')
                }, error => {
                    notice(sign, error.code, error.message)
                });
        })

        /* 
         * receive signin with mail
         *-------------------------------------------------------------------
         */
        // Confirm the link is a sign-in with email link.
        if (firebase.auth().isSignInWithEmailLink(window.location.href)) {

            let emailForSignIn = window.localStorage.getItem('emailForSignIn');

            // if emailForSignIn is not in localstorage, ask email to user
            if (!emailForSignIn) {

                emailForSignIn = window.prompt('Please provide your email for confirmation');
            }

            firebase.auth().signInWithEmailLink(emailForSignIn, window.location.href)
                .then(function (result) {
                    // Clear email from storage.
                    window.localStorage.removeItem('emailForSignIn');

                    // result
                    const isNewUser = result.additionalUserInfo.isNewUser
                    const providerId = result.additionalUserInfo.providerId
                    const credentialcredential = result.credentialcredential
                    const operationType = result.operationType
                    const user = result.user
                    console.log(isNewUser)
                    console.log(providerId)
                    console.log(credentialcredential)
                    console.log(operationType)
                    console.log(user)
                }, error => {
                    notice(sign, error.code, error.message)
                });
        }

        /* 
         * signin with provider
         *-------------------------------------------------------------------
         */
        signinProviders.forEach(signinProvider => {
            signinProvider.addEventListener('click', event => {
                const target = event.target.dataset
                let provider = null
                switch (target.provider) {
                    case 'google':
                        provider = new firebase.auth.GoogleAuthProvider()
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'login_hint': 'user@example.com'
                        })
                        break;

                    case 'facebook':
                        provider = new firebase.auth.FacebookAuthProvider();
                        // OAuth リクエストと一緒に送信したい追加のカスタム OAuth プロバイダ パラメータを指定します。
                        provider.setCustomParameters({
                            'display': 'popup'
                        });
                        break;

                    default:
                        break;
                }

                if (target.action == 'popup') {
                    firebase.auth().signInWithPopup(provider)
                        .then(result => {
                            // This gives you a Google Access Token. You can use it to access the Google API.
                            var token = result.credential.accessToken;
                            var user = result.user;
                            var credential = result.credential;
                            console.log(token)
                            console.log(user)
                            console.log(credential)
                        }, error => {
                            notice(sign, error.code, error.message)
                            console.log(error.email)
                            console.log(error.credential)
                        })
                }

                if (target.action == 'redirect') {
                    firebase.auth().signInWithRedirect(provider)
                }
            })
        })

        /* 
         * redirect receive
         */
        firebase.auth().getRedirectResult()
            .then(result => {
                if (result.credential) {
                    // This gives you a Google Access Token. You can use it to access the Google API.
                    var token = result.credential.accessToken;
                    var user = result.user;
                    var credential = result.credential;
                    console.log(token)
                    console.log(user)
                    console.log(uscredentialer)
                }
            }).catch(function (error) {
                notice(sign, error.code, error.message)
                console.log(error.email)
                console.log(error.credential)
            });

        /* 
         * sign out
         *-------------------------------------------------------------------
         */
        signout.addEventListener('click', () => {
            firebase.auth().signOut()
                .then(() => {
                    sign.innerHTML = 'signout!'
                }, error => {
                    notice(sign, error.code, error.message)
                })
        })

        /* 
         * chack signin type
         *-------------------------------------------------------------------
         */
        email.addEventListener('keyup', event => {
            getSigninMethodsFromEmailAddress(event.target.value)
                .then(result => {
                    console.log(result)
                    signin.disabled = result.hasPssword
                    signupMailLink.disabled = result.hasMailLink
                    signinGooglePopup = result.hasGoogle
                    signinGoogleRedirect = result.hasGoogle
                    signinFacebookPopup = result.hasFacebook
                    signinFacebookRedirect = result.hasFacebook
                    signinGithubPopup = result.hasGithub
                    signinGithubRedirect = result.hasGithub
                    signinhasTwitterPopup = result.hasTwitter
                    signinhasTwitterRedirect = result.hasTwitter

                    if (result.hasPssword) {
                        signup.disabled = false
                    } else {
                        signup.disabled = true
                    }
                })
                .catch(error => {
                    console.log('inputting...')
                })
        })

        /* 
         * check sign in
         *-------------------------------------------------------------------
         */
        checkSignin.addEventListener('click', event => {
            const currentUser = firebase.auth().currentUser;
            if (currentUser) {
                alert('user sign in!')
                console.log(currentUser)
                console.log(currentUser.displayName)
                console.log(currentUser.emailemail)
                console.log(currentUser.emailVerified)
                console.log(currentUser.metadata.creationTime)
                console.log(currentUser.metadata.lastSignInTime)
                console.log(currentUser.phoneNumber)
                console.log(currentUser.photoURL)
                console.log(currentUser.providerData)
            } else {
                alert('user not sign in!')
            }
        })

        /* 
         * change Auth state
         *-------------------------------------------------------------------
         */
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                notice(sign, 'info', 'signin!')
                // location.href = 'index.html'
            } else {
                notice(sign, 'info', 'not signin!')
            }
        })

        /* 
         * chack signin method
         *-------------------------------------------------------------------
         */
        function getSigninMethodsFromCurrentUser(currentUser) {

        }

        /* 
         * chack signin method
         *-------------------------------------------------------------------
         */
        function getSigninMethodsFromEmailAddress(emailAddress) {
            return new Promise((resolve, reject) => {
                firebase.auth().fetchSignInMethodsForEmail(emailAddress)
                    .then(signInMethods => {
                        const signinPassword = firebase.auth.EmailAuthProvider.EMAIL_PASSWORD_SIGN_IN_METHOD
                        const signinMailLink = firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD
                        resolve({
                            hasPssword: signInMethods.indexOf(signinPassword) != -1,
                            hasMailLink: signInMethods.indexOf(signinMailLink) != -1,
                            hasGoogle: signInMethods.indexOf("google.com") != -1,
                            hasFacebook: signInMethods.indexOf("facebook.com") != -1,
                            hasGithub: signInMethods.indexOf("github.com") != -1,
                            hasTwitter: signInMethods.indexOf("twitter.com") != -1
                        })
                    }, error => {
                        reject({
                            hasPssword: false,
                            hasMailLink: false,
                            hasGoogle: false,
                            hasFacebook: false,
                            hasMailLink: false,
                            hasMailLink: false
                        })
                    })
            });
        }

        function notice(elem, title, message){
            elem.innerHTML = `<h2>${title}</h2>
            <p>${message}</p>`
        }
    </script>
</body>

</html>